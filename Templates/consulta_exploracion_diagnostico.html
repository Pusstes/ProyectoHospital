{% if session['rol'] == 'MedicoAdmin' %}
    {% extends 'plantillaAdmin.html' %}
{% else %}
    {% extends 'plantilla.html' %}
{% endif %}

{% block body %}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h2 class="text-center mb-4">Registrar Diagnóstico y Exploración</h2>
            <div class="card shadow-sm">
                <div class="card-body">
                    <form id="diagnosticoForm" action="{{ url_for('registrar_diagnostico') }}" method="POST">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="numeroDeExpediente" class="form-label fw-bold">Número de Expediente</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fas fa-folder"></i></span>
                                        <input type="text" class="form-control" id="numeroDeExpediente" name="numeroDeExpediente" value="{{ numeroDeExpediente }}" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="FechaConsulta" class="form-label fw-bold">Fecha de Consulta</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fas fa-calendar"></i></span>
                                        <input type="date" class="form-control" id="FechaConsulta" name="FechaConsulta" value="{{ FechaConsulta }}" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="Peso" class="form-label fw-bold">Peso (kg)</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fas fa-weight"></i></span>
                                        <input type="number" step="0.01" class="form-control" id="Peso" name="Peso" value="{{ Peso }}" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="Altura" class="form-label fw-bold">Altura (cm)</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fas fa-ruler-vertical"></i></span>
                                        <input type="number" step="0.01" class="form-control" id="Altura" name="Altura" value="{{ Altura }}" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="Temperatura" class="form-label fw-bold">Temperatura (°C)</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fas fa-thermometer-half"></i></span>
                                        <input type="number" step="0.1" class="form-control" id="Temperatura" name="Temperatura" value="{{ Temperatura }}" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="LatidosxMinuto" class="form-label fw-bold">Latidos por Minuto</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fas fa-heartbeat"></i></span>
                                        <input type="number" class="form-control" id="LatidosxMinuto" name="LatidosxMinuto" value="{{ LatidosxMinuto }}" required>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="Glucosa" class="form-label fw-bold">Glucosa (mg/dL)</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="fas fa-tint"></i></span>
                                        <input type="number" step="0.01" class="form-control" id="Glucosa" name="Glucosa" value="{{ Glucosa }}" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="Sintomas" class="form-label fw-bold">Síntomas</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-notes-medical"></i></span>
                                <textarea class="form-control" id="Sintomas" name="Sintomas" rows="3" required>{{ Sintomas }}</textarea>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="Diagnostico" class="form-label fw-bold">Diagnóstico</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-stethoscope"></i></span>
                                <textarea class="form-control" placeholder="Enfermedad encontrada" id="Diagnostico" name="Diagnostico" rows="3" required>{{ Diagnostico }}</textarea>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="Tratamiento" class="form-label fw-bold">Tratamiento</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-prescription-bottle-alt"></i></span>
                                <textarea class="form-control" id="Tratamiento" placeholder="Medicamentos a recetar" name="Tratamiento" rows="3" required>{{ Tratamiento }}</textarea>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="Indicaciones" class="form-label fw-bold">Indicaciones</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-clipboard-list"></i></span>
                                <textarea class="form-control" placeholder="Como se usara el medicamento" id="Indicaciones" name="Indicaciones" rows="3" required>{{ Indicaciones }}</textarea>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label for="Estudios" class="form-label fw-bold">Estudios (opcional)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-flask"></i></span>
                                <textarea class="form-control" id="Estudios" name="Estudios" rows="3">{{ Estudios }}</textarea>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary w-100" onclick="confirmSubmit()">
                            <i class="fas fa-save me-2"></i>Guardar
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function confirmSubmit() {
        const numeroDeExpediente = document.getElementById('numeroDeExpediente').value.trim();
        const FechaConsulta = document.getElementById('FechaConsulta').value.trim();
        const Peso = document.getElementById('Peso').value.trim();
        const Altura = document.getElementById('Altura').value.trim();
        const Temperatura = document.getElementById('Temperatura').value.trim();
        const LatidosxMinuto = document.getElementById('LatidosxMinuto').value.trim();
        const Glucosa = document.getElementById('Glucosa').value.trim();
        const Sintomas = document.getElementById('Sintomas').value.trim();
        const Diagnostico = document.getElementById('Diagnostico').value.trim();
        const Tratamiento = document.getElementById('Tratamiento').value.trim();
        const Indicaciones = document.getElementById('Indicaciones').value.trim();
    
        // Aquí no incluimos el campo 'Estudios' ya que es opcional
        if (!numeroDeExpediente || !FechaConsulta || !Peso || !Altura || !Temperatura || 
            !LatidosxMinuto || !Glucosa || !Sintomas || !Diagnostico || !Tratamiento || !Indicaciones) {
            Swal.fire({
                title: 'Campos Vacíos',
                text: 'Por favor complete todos los campos obligatorios.',
                icon: 'warning',
                confirmButtonText: 'Entendido'
            });
            return;
        }
    
        // Aquí solo mostramos 'Estudios' si fue ingresado
        const Estudios = document.getElementById('Estudios').value.trim();
    
        Swal.fire({
            title: '¿Confirmar Registro?',
            html: `<b>Número de Expediente:</b> ${numeroDeExpediente}<br>
                   <b>Fecha de Consulta:</b> ${FechaConsulta}<br>
                   <b>Peso:</b> ${Peso}<br>
                   <b>Altura:</b> ${Altura}<br>
                   <b>Temperatura:</b> ${Temperatura}<br>
                   <b>Latidos por Minuto:</b> ${LatidosxMinuto}<br>
                   <b>Glucosa:</b> ${Glucosa}<br>
                   <b>Síntomas:</b> ${Sintomas}<br>
                   <b>Diagnóstico:</b> ${Diagnostico}<br>
                   <b>Tratamiento:</b> ${Tratamiento}<br>
                   <b>Indicaciones:</b> ${Indicaciones}<br>` + 
                   (Estudios ? `<b>Estudios:</b> ${Estudios}` : ''),
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Confirmar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('diagnosticoForm').submit();
            }
        });
    }
    
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $('#tu-formulario').on('submit', function(e) {
        e.preventDefault();

        $.ajax({
            url: "{{ url_for('registrar_diagnostico') }}",
            type: 'POST',
            data: $(this).serialize(),
            success: function(data) {
                handleResponse(data);
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
    });

    function handleResponse(data) {
        if (data.redirect_url) {
            window.location.href = data.redirect_url; // Redirige a la URL de la tabla de citas
        }

        if (data.pdf_url) {
            window.open(data.pdf_url, '_blank'); // Abre el PDF en una nueva pestaña
        }
    }
</script>

{% endblock %}