{% if session['rol'] == 'MedicoAdmin' %}
    {% extends 'plantillaAdmin.html' %}
{% else %}
    {% extends 'plantilla.html' %}
{% endif %}

{% block body %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="text-center mb-0">
                        <i class="fas fa-folder-open me-2"></i>Actualizar Expediente de Paciente
                    </h2>
                </div>
                <div class="card-body p-4">
                    <form id="expedienteUpdateForm" action="{{ url_for('actualizarExpediente', id=expediente[0]) }}" method="POST" class="needs-validation" novalidate>
                        <div class="mb-4">
                            <label for="medico" class="form-label">
                                <i class="fas fa-user-md me-2"></i>Médico
                            </label>
                            <input type="text" class="form-control" id="medico" name="medico" value="{{ session['nombre_medico'] }}" readonly>
                        </div>
                        
                        <div class="mb-4">
                            <label for="nombre_paciente" class="form-label">
                                <i class="fas fa-user me-2"></i>Paciente
                            </label>
                            <input type="text" class="form-control" id="nombre_paciente" name="nombre_paciente" value="{{ expediente[2] }}" required>
                            <div class="invalid-feedback">Este campo es obligatorio.</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="fecha_nacimiento" class="form-label">
                                <i class="fas fa-calendar-alt me-2"></i>Fecha de Nacimiento
                            </label>
                            <input type="date" class="form-control" name="fecha_nacimiento" id="fecha_nacimiento" value="{{ expediente[3] }}" required>
                            <div class="invalid-feedback">Este campo es obligatorio.</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="enfermedades_cronicas" class="form-label">
                                <i class="fas fa-heartbeat me-2"></i>Enfermedades Crónicas
                            </label>
                            <textarea class="form-control" name="enfermedades_cronicas" id="enfermedades_cronicas" rows="3" required>{{ expediente[4] }}</textarea>
                            <div class="invalid-feedback">Este campo es obligatorio.</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="alergias" class="form-label">
                                <i class="fas fa-allergies me-2"></i>Alergias
                            </label>
                            <textarea class="form-control" name="alergias" id="alergias" rows="3" required>{{ expediente[5] }}</textarea>
                            <div class="invalid-feedback">Este campo es obligatorio.</div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="antecedentes_familiares" class="form-label">
                                <i class="fas fa-users me-2"></i>Antecedentes Familiares
                            </label>
                            <textarea class="form-control" name="antecedentes_familiares" id="antecedentes_familiares" rows="3" required>{{ expediente[6] }}</textarea>
                            <div class="invalid-feedback">Este campo es obligatorio.</div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a id="cancelButton" href="{{ url_for('consultaP') }}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            <button type="button" class="btn btn-primary" onclick="confirmUpdate()">
                                <i class="fas fa-save me-2"></i>Actualizar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmUpdate() {
        const medico = document.getElementById('medico').value;
        const paciente = document.getElementById('nombre_paciente').value.trim();
        const fechaNacimiento = document.getElementById('fecha_nacimiento').value.trim();
        const enfermedades = document.getElementById('enfermedades_cronicas').value.trim();
        const alergias = document.getElementById('alergias').value.trim();
        const antecedentes = document.getElementById('antecedentes_familiares').value.trim();

        if (!paciente || !fechaNacimiento || !enfermedades || !alergias || !antecedentes) {
            Swal.fire({
                title: 'Campos Vacíos',
                text: 'Todos los campos son obligatorios. Por favor, completa todos los campos antes de actualizar.',
                icon: 'error',
                confirmButtonText: 'Aceptar'
            });
            return;
        }

        Swal.fire({
            title: '¿Confirmar Actualización?',
            html: `<div class="text-start">
                   <p><b><i class="fas fa-user-md me-2"></i>Médico:</b> ${medico}</p>
                   <p><b><i class="fas fa-user me-2"></i>Paciente:</b> ${paciente}</p>
                   <p><b><i class="fas fa-calendar-alt me-2"></i>Fecha de Nacimiento:</b> ${fechaNacimiento}</p>
                   <p><b><i class="fas fa-heartbeat me-2"></i>Enfermedades Crónicas:</b> ${enfermedades}</p>
                   <p><b><i class="fas fa-allergies me-2"></i>Alergias:</b> ${alergias}</p>
                   <p><b><i class="fas fa-users me-2"></i>Antecedentes Familiares:</b> ${antecedentes}</p>
                   </div>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Confirmar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('expedienteUpdateForm').submit();
            }
        });
    }

    document.getElementById('cancelButton').addEventListener('click', function(event) {
        event.preventDefault();

        Swal.fire({
            title: '¿Estás seguro?',
            text: '¿Deseas cancelar la actualización? Los cambios no guardados se perderán.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, cancelar',
            cancelButtonText: 'No, continuar editando'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = event.target.href;
            }
        });
    });
    
    // Validación de formulario
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            var forms = document.getElementsByClassName('needs-validation');
            var validation = Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();
</script>
{% endblock %}

